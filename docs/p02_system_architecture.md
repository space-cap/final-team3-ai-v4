# P02. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ (System Architecture)

## ğŸ— ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”

### ì•„í‚¤í…ì²˜ ì„¤ê³„ ì² í•™
ë³¸ ì‹œìŠ¤í…œì€ **ëª¨ë“ˆí™”**, **í™•ì¥ì„±**, **ì‹ ë¢°ì„±**ì„ í•µì‹¬ ì›ì¹™ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Web UI  â”‚  REST API  â”‚  CLI Tool  â”‚  Interactive Mode  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    FastAPI Gateway                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  LangGraph Workflow                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Request Analyzerâ”‚Template Gen. â”‚ Compliance Checker     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 Policy RAG Agent                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Vector DB     â”‚   Template   â”‚     LLM Client         â”‚
â”‚  (Chroma DB)    â”‚     Store    â”‚   (Claude API)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§© í•µì‹¬ ì»´í¬ë„ŒíŠ¸ ìƒì„¸

### 1. FastAPI Gateway Layer

#### ì—­í•  ë° ì±…ì„
- HTTP ìš”ì²­ ë¼ìš°íŒ… ë° ì²˜ë¦¬
- ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬
- ìš”ì²­/ì‘ë‹µ ê²€ì¦
- ì—ëŸ¬ í•¸ë“¤ë§ ë° ë¡œê¹…

#### ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸
```python
# í…œí”Œë¦¿ ìƒì„±
POST /api/v1/templates/generate
{
    "user_request": "ê°•ì˜ ìˆ˜ê°• ì‹ ì²­ ì™„ë£Œ ì•ˆë‚´",
    "business_type": "êµìœ¡",
    "tone": "ì •ì¤‘í•œ"
}

# í…œí”Œë¦¿ ê²€ì¦
POST /api/v1/templates/validate
{
    "template_text": "ìƒì„±ëœ í…œí”Œë¦¿ ë‚´ìš©",
    "business_type": "êµìœ¡"
}

# ì‹œìŠ¤í…œ ìƒíƒœ
GET /health
GET /stats
```

#### ë¯¸ë“¤ì›¨ì–´ êµ¬ì„±
- **CORS Middleware**: ë¸Œë¼ìš°ì € Cross-Origin ìš”ì²­ í—ˆìš©
- **Trusted Host Middleware**: í—ˆìš©ëœ í˜¸ìŠ¤íŠ¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥
- **Request Logging**: ëª¨ë“  ìš”ì²­ ë¡œê¹…
- **Rate Limiting**: API ì‚¬ìš©ëŸ‰ ì œí•œ

### 2. LangGraph Workflow Engine

#### ì›Œí¬í”Œë¡œìš° ì„¤ê³„
```python
# ì›Œí¬í”Œë¡œìš° ìƒíƒœ ì •ì˜
class WorkflowState(TypedDict):
    user_request: str
    request_analysis: Dict[str, Any]
    policy_context: str
    generated_template: Dict[str, Any]
    compliance_result: Dict[str, Any]
    iterations: int
    final_result: Dict[str, Any]
```

#### ë…¸ë“œ êµ¬ì„±
1. **ë¶„ì„ ë…¸ë“œ** (analyze_request)
   - ì‚¬ìš©ì ìš”ì²­ ë¶„ì„
   - ì—…ì¢… ë° ì„œë¹„ìŠ¤ ë¶„ë¥˜
   - í•„ìš” ë³€ìˆ˜ ì¶”ì¶œ

2. **ì •ì±… ê²€ìƒ‰ ë…¸ë“œ** (search_policies)
   - ê´€ë ¨ ì •ì±… ë¬¸ì„œ ê²€ìƒ‰
   - ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
   - ì˜ˆì‹œ í…œí”Œë¦¿ ì œê³µ

3. **ìƒì„± ë…¸ë“œ** (generate_template)
   - ì •ì±… ê¸°ë°˜ í…œí”Œë¦¿ ìƒì„±
   - ë³€ìˆ˜ ë° ë²„íŠ¼ ì„¤ì •
   - ì´ˆê¸° ìµœì í™”

4. **ê²€ì¦ ë…¸ë“œ** (check_compliance)
   - ì •ì±… ì¤€ìˆ˜ ê²€ì¦
   - ìœ„ë°˜ì‚¬í•­ ì‹ë³„
   - ê°œì„ ì  ì œì•ˆ

5. **ê°œì„  ë…¸ë“œ** (refine_template)
   - í”¼ë“œë°± ê¸°ë°˜ ê°œì„ 
   - ì¬ìƒì„± ë¡œì§
   - í’ˆì§ˆ í–¥ìƒ

#### ì¡°ê±´ë¶€ ë¼ìš°íŒ…
```python
def should_refine(state: WorkflowState) -> str:
    """ê°œì„  í•„ìš” ì—¬ë¶€ íŒë‹¨"""
    compliance = state.get("compliance_result", {})
    score = compliance.get("score", 0)
    iterations = state.get("iterations", 0)

    if score >= 85 or iterations >= 3:
        return "finish"
    else:
        return "refine"
```

### 3. Multi-Agent System

#### Agent ì„¤ê³„ ì›ì¹™
- **ë‹¨ì¼ ì±…ì„ ì›ì¹™**: ê° ì—ì´ì „íŠ¸ëŠ” íŠ¹ì • ì‘ì—…ì— íŠ¹í™”
- **ëŠìŠ¨í•œ ê²°í•©**: ì—ì´ì „íŠ¸ ê°„ ë…ë¦½ì  ë™ì‘
- **ì¬ì‚¬ìš© ê°€ëŠ¥ì„±**: ë‹¤ì–‘í•œ ì›Œí¬í”Œë¡œìš°ì—ì„œ í™œìš©

#### 3.1 Request Analyzer Agent
```python
class RequestAnalyzer:
    """ì‚¬ìš©ì ìš”ì²­ ë¶„ì„ ì—ì´ì „íŠ¸"""

    def analyze_request(self, user_request: str) -> Dict[str, Any]:
        """
        ìš”ì²­ ë¶„ì„ ìˆ˜í–‰

        ì¶œë ¥:
        - business_type: ì—…ì¢… ë¶„ë¥˜
        - service_type: ì„œë¹„ìŠ¤ ìœ í˜•
        - message_purpose: ë©”ì‹œì§€ ëª©ì 
        - required_variables: í•„ìš” ë³€ìˆ˜
        - tone: ê¶Œì¥ í†¤ì•¤ë§¤ë„ˆ
        """
```

**ë¶„ë¥˜ ì•Œê³ ë¦¬ì¦˜**:
1. **í‚¤ì›Œë“œ ê¸°ë°˜ 1ì°¨ ë¶„ë¥˜**
2. **LLM ê¸°ë°˜ ì •ë°€ ë¶„ì„**
3. **ì‹ ë¢°ë„ ì ìˆ˜ ê³„ì‚°**
4. **ì˜ˆì™¸ ìƒí™© ì²˜ë¦¬**

#### 3.2 Policy RAG Agent
```python
class PolicyRAGAgent:
    """ì •ì±… ë¬¸ì„œ ê²€ìƒ‰ ë° ì»¨í…ìŠ¤íŠ¸ ì œê³µ ì—ì´ì „íŠ¸"""

    def search_relevant_policies(self, query: str) -> str:
        """ê´€ë ¨ ì •ì±… ê²€ìƒ‰"""

    def get_template_examples(self, business_type: str) -> List[Dict]:
        """ì—…ì¢…ë³„ ì˜ˆì‹œ í…œí”Œë¦¿ ì œê³µ"""

    def validate_against_blacklist(self, content: str) -> Dict[str, Any]:
        """ê¸ˆì§€ í•­ëª© ê²€ì¦"""
```

**ê²€ìƒ‰ ì „ëµ**:
- **ì˜ë¯¸ì  ìœ ì‚¬ë„**: ë²¡í„° ì„ë² ë”© ê¸°ë°˜ ê²€ìƒ‰
- **í‚¤ì›Œë“œ ë§¤ì¹­**: ì •í™•í•œ ìš©ì–´ ë§¤ì¹­
- **ì¹´í…Œê³ ë¦¬ í•„í„°ë§**: ì—…ì¢…/ì •ì±… ìœ í˜•ë³„ í•„í„°
- **ìŠ¤ì½”ì–´ ê¸°ë°˜ ë­í‚¹**: ê´€ë ¨ë„ ìˆœ ì •ë ¬

#### 3.3 Template Generator Agent
```python
class TemplateGenerator:
    """í…œí”Œë¦¿ ìƒì„± ì—ì´ì „íŠ¸"""

    def generate_template(self, analysis: Dict, context: str) -> Dict[str, Any]:
        """ê¸°ë³¸ í…œí”Œë¦¿ ìƒì„±"""

    def optimize_template(self, template: str, feedback: Dict) -> str:
        """í”¼ë“œë°± ê¸°ë°˜ ìµœì í™”"""

    def extract_variables(self, template: str) -> List[str]:
        """ë³€ìˆ˜ ìë™ ì¶”ì¶œ"""
```

**ìƒì„± ì „ëµ**:
1. **êµ¬ì¡° ê¸°ë°˜ ìƒì„±**: ìŠ¹ì¸ëœ í…œí”Œë¦¿ êµ¬ì¡° í™œìš©
2. **ì»¨í…ìŠ¤íŠ¸ ì£¼ì…**: ì •ì±… ì •ë³´ ë°˜ì˜
3. **ë³€ìˆ˜ ìµœì í™”**: ì ì ˆí•œ ë³€ìˆ˜ ì‚¬ìš©
4. **ê¸¸ì´ ì¡°ì ˆ**: 1000ì ì´ë‚´ ì œí•œ ì¤€ìˆ˜

#### 3.4 Compliance Checker Agent
```python
class ComplianceChecker:
    """ì •ì±… ì¤€ìˆ˜ ê²€ì¦ ì—ì´ì „íŠ¸"""

    def check_compliance(self, template: Dict) -> Dict[str, Any]:
        """ì¢…í•© ì»´í”Œë¼ì´ì–¸ìŠ¤ ê²€ì¦"""

    def calculate_score(self, violations: List, warnings: List) -> int:
        """ì ìˆ˜ ê³„ì‚°"""

    def suggest_improvements(self, issues: List) -> List[str]:
        """ê°œì„ ì  ì œì•ˆ"""
```

**ê²€ì¦ í•­ëª©**:
- **ê¸°ë³¸ ê·œì¹™**: ê¸¸ì´, ì¸ì‚¬ë§, ì •ë³´ì„± í‘œì‹œ
- **ê¸ˆì§€ í•­ëª©**: ê´‘ê³ ì„± í‚¤ì›Œë“œ, ë¶€ì ì ˆí•œ í‘œí˜„
- **ë³€ìˆ˜ ì‚¬ìš©**: ë³€ìˆ˜ ê°œìˆ˜, í˜•ì‹ ê²€ì¦
- **êµ¬ì¡° ê²€ì¦**: ë©”ì‹œì§€ êµ¬ì¡° ì ì ˆì„±

### 4. ë°ì´í„° ë ˆì´ì–´

#### 4.1 Vector Database (Chroma DB)
```python
class PolicyVectorStore:
    """ì •ì±… ë¬¸ì„œ ë²¡í„° ìŠ¤í† ì–´"""

    def __init__(self):
        self.embeddings = OpenAIEmbeddings()
        self.vector_store = Chroma(
            persist_directory="./chroma_db",
            embedding_function=self.embeddings
        )
```

**ë°ì´í„° êµ¬ì¡°**:
```json
{
    "content": "ì •ì±… ë¬¸ì„œ ë‚´ìš©",
    "metadata": {
        "source": "audit.md",
        "policy_type": "review_guidelines",
        "chunk_id": 0,
        "category": "compliance"
    }
}
```

#### 4.2 Template Store
```python
class TemplateStore:
    """ìŠ¹ì¸ëœ í…œí”Œë¦¿ ì €ì¥ì†Œ"""

    def find_similar_templates(self, business_type: str, service_type: str):
        """ìœ ì‚¬ í…œí”Œë¦¿ ê²€ìƒ‰"""

    def get_approval_patterns(self, category: str):
        """ìŠ¹ì¸ íŒ¨í„´ ë¶„ì„"""
```

**í…œí”Œë¦¿ ë©”íƒ€ë°ì´í„°**:
```json
{
    "id": "template_001",
    "text": "í…œí”Œë¦¿ ë‚´ìš©",
    "metadata": {
        "business_type": "êµìœ¡",
        "service_type": "ì‹ ì²­",
        "approval_status": "approved",
        "category_1": "êµìœ¡/í•™ìŠµ",
        "category_2": "ìˆ˜ê°•ì‹ ì²­",
        "variables": ["ìˆ˜ì‹ ìëª…", "ê°•ì˜ëª…"],
        "compliance_score": 95
    }
}
```

## ğŸ”„ ë°ì´í„° íë¦„ (Data Flow)

### 1. ìš”ì²­ ì²˜ë¦¬ íë¦„
```
ì‚¬ìš©ì ìš”ì²­ â†’ FastAPI â†’ ìš”ì²­ ê²€ì¦ â†’ LangGraph ì›Œí¬í”Œë¡œìš°
    â†“
Request Analyzer â†’ ìš”ì²­ ë¶„ì„ ê²°ê³¼
    â†“
Policy RAG â†’ ê´€ë ¨ ì •ì±… ê²€ìƒ‰ â†’ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
    â†“
Template Generator â†’ í…œí”Œë¦¿ ìƒì„±
    â†“
Compliance Checker â†’ ì •ì±… ì¤€ìˆ˜ ê²€ì¦
    â†“
[ì ìˆ˜ < 85] â†’ Template Refiner â†’ ê°œì„ ëœ í…œí”Œë¦¿
    â†“
[ì ìˆ˜ â‰¥ 85] â†’ ìµœì¢… ê²°ê³¼ ë°˜í™˜ â†’ FastAPI â†’ ì‚¬ìš©ì
```

### 2. ì—ëŸ¬ ì²˜ë¦¬ íë¦„
```
ì—ëŸ¬ ë°œìƒ â†’ Exception Handler â†’ ë¡œê¹…
    â†“
ì—ëŸ¬ ë¶„ë¥˜ (ì‹œìŠ¤í…œ/ì‚¬ìš©ì/ì™¸ë¶€)
    â†“
ì ì ˆí•œ ì‘ë‹µ ì½”ë“œ ë° ë©”ì‹œì§€ ìƒì„±
    â†“
ì‚¬ìš©ìì—ê²Œ ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
```

## ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ ìƒì„¸

### Backend Framework
- **FastAPI 0.115.0**: ê³ ì„±ëŠ¥ ì›¹ í”„ë ˆì„ì›Œí¬
- **Uvicorn**: ASGI ì›¹ ì„œë²„
- **Pydantic**: ë°ì´í„° ê²€ì¦ ë° ì‹œë¦¬ì–¼ë¼ì´ì œì´ì…˜

### AI/ML Framework
- **LangChain 0.2.16**: LLM ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë ˆì„ì›Œí¬
- **LangGraph**: ì›Œí¬í”Œë¡œìš° ê´€ë¦¬
- **Anthropic Claude API**: ëŒ€í™”í˜• AI ëª¨ë¸

### Database & Storage
- **Chroma DB**: ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤
- **OpenAI Embeddings**: í…ìŠ¤íŠ¸ ì„ë² ë”©
- **JSON**: í…œí”Œë¦¿ ë° ì„¤ì • ì €ì¥

### Development & Operations
- **Python 3.11**: í”„ë¡œê·¸ë˜ë° ì–¸ì–´
- **Poetry/pip**: ì˜ì¡´ì„± ê´€ë¦¬
- **Docker**: ì»¨í…Œì´ë„ˆí™”
- **GitHub Actions**: CI/CD

## ğŸ“Š ì„±ëŠ¥ ë° í™•ì¥ì„±

### ì„±ëŠ¥ ìµœì í™”
- **ë¹„ë™ê¸° ì²˜ë¦¬**: FastAPI async/await í™œìš©
- **ì—°ê²° í’€ë§**: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìµœì í™”
- **ìºì‹± ì „ëµ**: ìì£¼ ì‚¬ìš©ë˜ëŠ” ì •ì±… ìºì‹±
- **ë°°ì¹˜ ì²˜ë¦¬**: ë²¡í„° ê²€ìƒ‰ ìµœì í™”

### í™•ì¥ì„± ê³ ë ¤ì‚¬í•­
- **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤**: ê° ì—ì´ì „íŠ¸ ë…ë¦½ ë°°í¬ ê°€ëŠ¥
- **ë¡œë“œ ë°¸ëŸ°ì‹±**: ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ì§€ì›
- **ìˆ˜í‰ í™•ì¥**: ì¶”ê°€ ì„œë²„ ì¦ì„¤ ìš©ì´
- **ëª¨ë‹ˆí„°ë§**: ì„±ëŠ¥ ë©”íŠ¸ë¦­ ì‹¤ì‹œê°„ ì¶”ì 

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### API ë³´ì•ˆ
- **ì¸ì¦**: API í‚¤ ê¸°ë°˜ ì¸ì¦
- **ê¶Œí•œ ë¶€ì—¬**: ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´
- **ìš”ì²­ ì œí•œ**: Rate limiting ì ìš©
- **ì…ë ¥ ê²€ì¦**: ëª¨ë“  ì…ë ¥ ë°ì´í„° ê²€ì¦

### ë°ì´í„° ë³´ì•ˆ
- **ì•”í˜¸í™”**: ë¯¼ê°í•œ ë°ì´í„° ì•”í˜¸í™” ì €ì¥
- **ë§ˆìŠ¤í‚¹**: ë¡œê·¸ì—ì„œ ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹
- **ë°±ì—…**: ì •ê¸°ì  ë°ì´í„° ë°±ì—…
- **ê°ì‚¬**: ëª¨ë“  ì‘ì—… ë¡œê·¸ ê¸°ë¡

---

**ğŸ“… ì‘ì„±ì¼**: 2024ë…„ 9ì›” 19ì¼
**âœï¸ ì‘ì„±ì**: Final Team 3 AI
**ğŸ“„ ë¬¸ì„œ ë²„ì „**: 1.0
**ğŸ”„ ìµœì¢… ìˆ˜ì •**: 2024ë…„ 9ì›” 19ì¼